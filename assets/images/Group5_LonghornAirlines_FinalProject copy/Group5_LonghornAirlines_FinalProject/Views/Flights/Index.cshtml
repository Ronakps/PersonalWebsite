@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@model IEnumerable<Group5_LonghornAirlines_FinalProject.Models.Flight>

@inject UserManager<AppUser> UserManager

@{
    ViewData["Title"] = "Index";
    // Attempt to retrieve the logged-in user's ID
    string userId = User.Identity.IsAuthenticated ? UserManager.GetUserId(User) : null;

    // Define the helper function to map City enum values to string representations
    Func<City, string> GetCityString = (city) =>
    {
        switch (city)
        {
            case City.AUS:
                return "AUS: Austin, Texas";
            case City.ELP:
                return "ELP: El Paso, Texas";
            case City.DFW:
                return "DFW: Dallas, Texas";
            case City.HOU:
                return "HOU: Houston, Texas";
            default:
                return "Unknown";
        }
    };
}

<h1>Home Page</h1>

<form asp-action="Index" asp-controller="Flights" method="get">
    <p class="form-group">
        Search Flight Number or go to detailed search: <input name="SearchString" class="form-control" /><br />
        <button type="submit" class="btn btn-primary">Search</button>
        <a asp-action="DetailedSearch" class="btn btn-success">Detailed Search</a>
        <a asp-action="Index" class="btn btn-danger">Show All</a>

        @if (User.IsInRole("Manager"))
        {
        <p>
            <a asp-action="Report" asp-controller="Flights" class="btn btn-danger">View Reports</a>
        </p>
    }
    </form>

    @if (User.Identity.IsAuthenticated && userId != null)
    {
        <p>
            <a asp-action="ViewCustomers" asp-controller="Flights" class="btn btn-danger">View Customers </a>
        </p>
    }


    @if (User.Identity.IsAuthenticated && userId != null)
    {
        <p>
            <!-- Profile Button for logged in users -->
            <a asp-controller="AppUser" asp-action="Details" asp-route-id="@userId" class="btn btn-info">View My Profile</a>
        </p>
    }

    <p>
        Displaying @ViewBag.SelectedFlightCount of @ViewBag.TotalFlightCount Flights
    </p>

    @if (User.IsInRole("Manager"))
    {
        <p>
            <a asp-action="Create" asp-controller="Flights" class="btn btn-warning">Add New Flights</a>
        </p>
    }

    <table class="table">
        <thead>
            <tr>
                <th>
                    @Html.DisplayNameFor(model => model.FlightNumber)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.DepartureTime)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.EconomyPrice)
                </th>
                <th>
                    Departure City
                </th>
                <th>
                    Arrival City
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.status)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.DepDays)
                </th>
                <th>
                    Theoretical Flight Progress
                </th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>
                        @Html.DisplayFor(modelItem => item.FlightNumber)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.DepartureTime)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.EconomyPrice)
                    </td>
                    <td>
                        @GetCityString(item.FlightPath.DepartureCity)
                    </td>
                    <td>
                        @GetCityString(item.FlightPath.ArrivalCity)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.status)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.DepDays)
                    </td>
                <td>
                    @{
                        // Check if the flight has departed
                        if (DateTime.Now > item.DepartureTime.Add(item.FlightPath.Duration))
                        {
                            <span>Flight arrived</span>
                        }
                        // Check if the flight is in the air
                        else if (item.DepartureTime.Add(item.FlightPath.Duration) > DateTime.Now && DateTime.Now > item.DepartureTime)
                        {
                            // Calculate flight progress percentage
                            double totalDurationMinutes = item.FlightPath.Duration.TotalMinutes;
                            double elapsedMinutes = (DateTime.Now - item.DepartureTime).TotalMinutes;
                            double progressPercentage = (elapsedMinutes / totalDurationMinutes) * 100;
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: @(progressPercentage)%;" aria-valuenow="@progressPercentage" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                        }
                        else
                        {
                            <span>Flight not departed yet</span>
                        }
                    }
                </td>
                    <td>
                        @* Check if the flight has not departed *@
                        @if (item.status != Status.Departed)
                        {
                            <a asp-action="Create" asp-controller="Reservation" asp-route-flightid="@item.FlightID">Purchase</a>
                        }
                        else
                        {
                            <span>Flight already departed</span>
                        }

                        @if (User.IsInRole("Manager") || User.IsInRole("Agent"))
                        {
                            @if (item.status != Status.Departed)
                            {
                                <a asp-action="CheckIn" asp-route-id="@item.FlightID">Check In</a>
                            }
                            else
                            {
                                <span> </span>
                            }
                        }

                        @if (User.IsInRole("Manager"))
                        {
                            @if (item.status != Status.Departed)
                            {
                                <a asp-action="Edit" asp-route-id="@item.FlightID">Edit</a>
                            }
                            else
                            {
                                <span>Flight already departed</span>
                            }
                        }
                    </td>
                    <td>
                        @if (User.IsInRole("Manager"))
                        {
                            @if (item.status != Status.Canceled)
                            {
                                <a asp-action="Delete" asp-route-id="@item.FlightID">Cancel</a>
                                <a asp-action="FlightManifest" asp-route-id="@item.FlightID">View Flight Manifest</a>
                            }
                        }
                        <a asp-action="Details" asp-route-id="@item.FlightID">Details</a>
                    </td>
                </tr>
            }
        </tbody>

    <style>
        .progress {
            height: 20px;
            margin-bottom: 0;
            overflow: hidden;
            background-color: #f5f5f5;
            border-radius: 4px;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            float: left;
            width: 0;
            height: 100%;
            font-size: 12px;
            line-height: 20px;
            color: #fff;
            text-align: center;
            background-color: #337ab7;
            box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.15);
            transition: width 0.6s ease;
        }
    </style>
    </table>



